# Data Model: Flexible Aspect-Ratio Image Layout

**Feature**: 007-flexible-layout
**Date**: 2025-11-02
**Status**: Complete

## Overview

This document defines the data structures required to support flexible aspect-ratio image layout. The core requirement is to calculate and apply optimal image positioning based on actual dimensions while maintaining zero layout shift.

---

## Entities

### 1. ImageDimensions

Represents the physical dimensions of an image file.

**Purpose**: Store width and height of images to enable layout calculations without loading the image file in the browser.

**Fields**:
- `width` (int, required): Image width in pixels
- `height` (int, required): Image height in pixels
- `aspect_ratio` (float, computed): Width divided by height

**Validation Rules**:
- `width` must be > 0
- `height` must be > 0
- Both dimensions must be integers

**Relationships**:
- Belongs to exactly one `Image` (model.py)
- Used to calculate `LayoutGeometry`

**State Transitions**: Immutable once extracted from image file

**Example**:
```python
ImageDimensions(width=1920, height=1080)  # aspect_ratio = 1.78
```

---

### 2. LayoutGeometry

Represents the calculated position and size for displaying an image in the layout.

**Purpose**: Define where and how large each image should be rendered to achieve justified layout.

**Fields**:
- `x` (float, required): Horizontal position in pixels from container left
- `y` (float, required): Vertical position in pixels from container top
- `width` (float, required): Rendered width in pixels
- `height` (float, required): Rendered height in pixels
- `aspect_ratio` (float, required): Original aspect ratio (preserved from ImageDimensions)

**Validation Rules**:
- All numeric fields must be >= 0
- `aspect_ratio` must equal `width / height` (within floating point tolerance)
- Position must be within container bounds

**Relationships**:
- Computed from `ImageDimensions` via `LayoutAlgorithm`
- One per `Image` in the gallery
- Part of a `LayoutRow`

**State Transitions**: Recalculated on viewport resize

**Example**:
```javascript
{
  x: 0,
  y: 0,
  width: 400,
  height: 225,
  aspect_ratio: 1.78
}
```

---

### 3. LayoutRow

Groups images arranged horizontally in a single row with consistent height.

**Purpose**: Organize images into rows as determined by the justified layout algorithm.

**Fields**:
- `images` (array of LayoutGeometry, required): Images in this row
- `row_height` (float, required): Common height for all images in this row
- `y_position` (float, required): Vertical position of the row
- `total_width` (float, computed): Sum of all image widths in the row
- `aspect_ratio_sum` (float, computed): Sum of aspect ratios for all images

**Validation Rules**:
- `images` must contain at least 1 item
- All images in `images` must have the same `height` value (equal to `row_height`)
- All images must have the same `y` position (equal to `y_position`)
- `total_width` should approximately equal container width (within justified layout tolerance)

**Relationships**:
- Contains multiple `LayoutGeometry` items
- Part of a `LayoutResult`
- Computed by `LayoutAlgorithm`

**State Transitions**: Recreated on layout recalculation

**Example**:
```javascript
{
  images: [
    { x: 0, y: 0, width: 400, height: 225, aspect_ratio: 1.78 },
    { x: 408, y: 0, width: 350, height: 225, aspect_ratio: 1.56 }
  ],
  row_height: 225,
  y_position: 0,
  total_width: 758,
  aspect_ratio_sum: 3.34
}
```

---

### 4. LayoutResult

Complete layout calculation output for an entire gallery or category.

**Purpose**: Encapsulate all positioning data for rendering images in the justified layout.

**Fields**:
- `rows` (array of LayoutRow, required): All rows in the layout
- `container_width` (float, required): Width of container used for calculation
- `total_height` (float, computed): Sum of all row heights
- `image_count` (int, computed): Total number of images
- `calculation_time_ms` (float, optional): Performance metric

**Validation Rules**:
- `rows` must contain at least 1 item
- `container_width` must be > 0
- All rows must be non-overlapping (y positions must be sequential)
- `image_count` must equal sum of images across all rows

**Relationships**:
- Contains multiple `LayoutRow` items
- Generated by `LayoutAlgorithm`
- Consumed by rendering layer

**State Transitions**: Regenerated on viewport resize or initial load

**Example**:
```javascript
{
  rows: [
    { images: [...], row_height: 225, y_position: 0 },
    { images: [...], row_height: 240, y_position: 233 }
  ],
  container_width: 1200,
  total_height: 473,
  image_count: 6,
  calculation_time_ms: 2.3
}
```

---

### 5. LayoutAlgorithm

Service/function that computes optimal image positioning.

**Purpose**: Implement the justified layout algorithm to calculate positions and sizes.

**Input**:
- `images` (array of ImageDimensions, required): Images to layout
- `container_width` (float, required): Available width for layout
- `target_row_height` (float, optional): Desired row height in pixels (default: 320)
- `max_row_height` (float, optional): Maximum allowed row height (default: 480)
- `spacing` (float, optional): Gap between images in pixels (default: 8)

**Output**: `LayoutResult`

**Algorithm**:
1. Initialize empty row array
2. For each image:
   - Add image to current row
   - Calculate row width if all images scaled to target height
   - If row width >= container width:
     - Calculate optimal row height to fit container exactly
     - Clamp height between min and max bounds
     - Create LayoutRow with calculated positions
     - Start new row
3. Process final partial row
4. Return LayoutResult

**Performance Requirements**:
- Must complete in <500ms for 100 images
- Memory usage O(n) where n = number of images
- Should be deterministic (same input → same output)

**Example Usage**:
```javascript
const layout = calculateLayout(
  imageDimensions,
  containerWidth: 1200,
  targetRowHeight: 320,
  spacing: 8
);
```

---

## Data Flow

```
1. Build Time (Python):
   Image File → [Pillow] → ImageDimensions → [Jinja2] → HTML data attributes

2. Browser Load (JavaScript):
   HTML data attributes → ImageDimensions[] → LayoutAlgorithm → LayoutResult

3. Rendering:
   LayoutResult → [DOM manipulation] → Positioned Images

4. Resize Event:
   New container width → LayoutAlgorithm → New LayoutResult → Update positions
```

---

## Existing Model Updates

### Image (src/generator/model.py)

**Current**:
```python
class Image(BaseModel):
    filename: str
    file_path: Path
    category: str
    title: str = ""
    description: str = ""
```

**Required Changes**:
```python
class Image(BaseModel):
    filename: str
    file_path: Path
    category: str
    width: Optional[int] = None      # NEW
    height: Optional[int] = None     # NEW
    title: str = ""
    description: str = ""

    @property
    def aspect_ratio(self) -> Optional[float]:  # NEW
        """Calculate aspect ratio if dimensions available."""
        if self.width and self.height:
            return self.width / self.height
        return None
```

**Validation Rules**:
- If `width` is set, `height` must also be set (and vice versa)
- Both must be positive integers if present

---

## Template Data Structure

### index.html.j2 Template Variables

**Current**:
```jinja
image = {
    'filename': str,
    'category': str,
    'title': str,
    'description': str,
    'alt_text': str,
    'src': str
}
```

**Required Changes**:
```jinja
image = {
    'filename': str,
    'category': str,
    'title': str,
    'description': str,
    'alt_text': str,
    'src': str,
    'width': int,          # NEW
    'height': int          # NEW
}
```

---

## JavaScript Data Structures

### ImageData (for layout calculation)

```typescript
interface ImageData {
  index: number;           // Position in gallery
  width: number;           // Original width
  height: number;          // Original height
  aspectRatio: number;     // width / height
  element: HTMLElement;    // DOM reference (optional)
}
```

### LayoutConfig (algorithm parameters)

```typescript
interface LayoutConfig {
  containerWidth: number;       // Available width
  targetRowHeight?: number;     // Default: 320px
  maxRowHeight?: number;        // Default: 480px
  spacing?: number;             // Default: 8px
  minAspectRatio?: number;      // Default: 0.25 (1:4)
  maxAspectRatio?: number;      // Default: 4.0 (4:1)
}
```

---

## Persistence

**No database persistence required** - All data is either:
1. Extracted at build time from image files (width/height)
2. Computed at runtime in browser (layout positions)
3. Stored in YAML configuration (titles, descriptions, categories)

---

## Migration Path

### Phase 1: Add dimension fields (backward compatible)
- `Image.width` and `Image.height` optional
- Old galleries without dimensions use CSS Grid fallback
- New galleries with dimensions use justified layout

### Phase 2: Populate dimensions
- Scanner extracts dimensions for all images
- YAML does not store dimensions (computed at build time)

### Phase 3: Make dimensions required (breaking change)
- Update `Image` model to require width/height
- Scanner fails if dimensions cannot be extracted
- Ensures all galleries support justified layout

---

## Testing Strategy

### Unit Tests
- `ImageDimensions` validation (positive values, aspect ratio calculation)
- `LayoutAlgorithm` correctness (row formation, height calculation)
- Edge cases (single image, extreme aspect ratios, narrow containers)

### Integration Tests
- Image dimension extraction from files
- Template rendering with dimensions
- JavaScript layout calculation with real DOM

### Property-Based Tests
- Any set of valid dimensions should produce valid layout
- Total image area should be approximately constant
- No overlapping images

---

## Open Questions

1. **Q**: Should we cache calculated layouts in sessionStorage?
   - **A**: Not initially - calculation is fast (<20ms). Could optimize later if needed.

2. **Q**: Should dimensions be stored in YAML for manual override?
   - **A**: No - dimensions should always be extracted from actual files to prevent mismatches.

3. **Q**: How to handle images that fail dimension extraction?
   - **A**: Log warning and exclude from gallery OR use placeholder dimensions and CSS Grid fallback.

---

## Summary

The data model introduces **ImageDimensions** at build time and **LayoutGeometry/LayoutRow/LayoutResult** at runtime. The existing `Image` model gains optional `width` and `height` fields. The layout algorithm is pure function that transforms dimensions into positions. No database or persistent storage is required - all calculations happen at build time (dimension extraction) and runtime (layout positioning).
